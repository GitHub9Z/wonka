# 本地构建 Docker 镜像指南

## 快速开始

### 方式一：使用自动化脚本（推荐）

**一条命令完成所有步骤：**
```bash
cd backend
./构建并部署.sh 你的服务器IP root
```

这会自动：
1. ✅ 构建镜像
2. ✅ 保存镜像为文件
3. ✅ 上传到服务器
4. ✅ 在服务器上部署

---

### 方式二：分步操作

#### 步骤 1：构建镜像

```bash
cd backend
./构建镜像.sh
```

或者手动构建：
```bash
docker build -t wonka-backend:latest .
```

**构建过程：**
- 会安装所有依赖
- 编译 TypeScript 代码
- 构建管理后台页面
- 打包成最终镜像

**预计时间：** 3-10 分钟（取决于网络和电脑性能）

---

#### 步骤 2：验证镜像

构建完成后，检查镜像：
```bash
docker images wonka-backend:latest
```

应该看到类似这样的输出：
```
REPOSITORY        TAG       IMAGE ID       CREATED         SIZE
wonka-backend     latest    abc123def456   2 minutes ago   500MB
```

---

#### 步骤 3：保存镜像为文件

```bash
./保存镜像.sh
```

或者手动保存：
```bash
docker save wonka-backend:latest -o wonka-backend.tar
```

**文件大小：** 通常 200-500MB（取决于依赖）

---

#### 步骤 4：上传到服务器

```bash
scp wonka-backend.tar root@你的服务器IP:/opt/wonka-backend/
```

---

#### 步骤 5：在服务器上部署

```bash
ssh root@你的服务器IP

cd /opt/wonka-backend

# 加载镜像
docker load -i wonka-backend.tar

# 使用生产配置启动（需要先创建 docker-compose.yml 和 .env）
docker-compose -f docker-compose.prod.yml up -d
```

---

## 本地测试镜像

在部署前，可以先在本地测试镜像是否正常：

```bash
# 运行镜像（需要本地有 MongoDB 或使用 docker-compose）
docker run -d \
  --name wonka-backend-test \
  -p 3000:3000 \
  -e NODE_ENV=production \
  -e PORT=3000 \
  -e MONGODB_URI=mongodb://host.docker.internal:27017/wonka \
  -e JWT_SECRET=test-secret \
  wonka-backend:latest

# 查看日志
docker logs -f wonka-backend-test

# 测试健康检查
curl http://localhost:3000/health

# 停止测试容器
docker stop wonka-backend-test
docker rm wonka-backend-test
```

---

## 常见问题

### 1. 构建失败：内存不足

**错误信息：** `JavaScript heap out of memory`

**解决：**
```bash
# 增加 Node.js 内存限制（在 Dockerfile 中已设置）
# 或者本地构建时设置环境变量
NODE_OPTIONS=--max-old-space-size=4096 docker build -t wonka-backend:latest .
```

### 2. 构建失败：网络问题

**错误信息：** `npm install` 超时或失败

**解决：**
- 检查网络连接
- 使用国内镜像源（在 Dockerfile 中添加）
- 重试构建

### 3. 镜像文件太大

**问题：** `wonka-backend.tar` 文件超过 1GB

**解决：**
- 使用多阶段构建（已在 Dockerfile 中使用）
- 清理未使用的镜像：`docker system prune -a`
- 使用 `.dockerignore` 排除不需要的文件（已配置）

### 4. 上传镜像文件太慢

**解决：**
- 使用压缩：`docker save wonka-backend:latest | gzip > wonka-backend.tar.gz`
- 上传压缩文件，在服务器上解压：`gunzip -c wonka-backend.tar.gz | docker load`
- 或者使用 Docker Hub（见下方）

---

## 使用 Docker Hub（可选）

如果镜像文件太大或上传太慢，可以使用 Docker Hub：

### 1. 登录 Docker Hub

```bash
docker login
```

### 2. 给镜像打标签

```bash
docker tag wonka-backend:latest 你的用户名/wonka-backend:latest
```

### 3. 推送到 Docker Hub

```bash
docker push 你的用户名/wonka-backend:latest
```

### 4. 在服务器上拉取

```bash
ssh root@服务器IP
docker pull 你的用户名/wonka-backend:latest
```

---

## 更新镜像

当代码更新后，重新构建：

```bash
# 1. 重新构建
./构建镜像.sh

# 2. 保存新镜像
./保存镜像.sh

# 3. 部署（会自动替换旧镜像）
./部署脚本.sh 服务器IP
```

或者一键完成：
```bash
./构建并部署.sh 服务器IP
```

---

## 脚本说明

### `构建镜像.sh`
- 检查 Docker 是否安装
- 检查 Dockerfile 是否存在
- 构建镜像
- 显示镜像信息

### `保存镜像.sh`
- 检查镜像是否存在
- 保存镜像为 tar 文件
- 显示文件大小

### `部署脚本.sh`
- 检查镜像文件是否存在
- 上传到服务器
- 在服务器上加载镜像
- 启动服务

### `构建并部署.sh`
- 一键完成：构建 → 保存 → 部署

---

## 提示

1. **首次构建较慢**：需要下载基础镜像和安装依赖，耐心等待
2. **后续构建更快**：Docker 会缓存已构建的层
3. **定期清理**：`docker system prune -a` 清理未使用的镜像
4. **查看构建过程**：构建时会显示详细日志，可以看到每一步
5. **测试很重要**：部署前先在本地测试镜像是否正常

---

## 下一步

镜像构建完成后，参考 `DEPLOY.md` 了解如何在服务器上部署和配置。


